---
// ProgressiveVideo.astro
export interface Props {
  placeholderImage: string;
  compressedVideo: string;
  qualityVideo: string;
  startTimestamp: number;
  width?: number;
  height?: number;
  className?: string;
  alt?: string;
  muted?: boolean;
  loop?: boolean;
  controls?: boolean;
  preloadQuality?: "none" | "metadata" | "auto";
  fullWidth?: boolean;
  containerStyle?: string;
  portraitAspectRatio?: string;
  landscapeAspectRatio?: string;
  maxWidthBreakpoint1?: number;
  breakpointStyles1?: string;
  maxWidthBreakpoint2?: number;
  breakpointStyles2?: string;
  maxWidthBreakpoint3?: number;
  breakpointStyles3?: string;
  maxWidthBreakpoint4?: number;
  breakpointStyles4?: string;
  maxWidthBreakpoint5?: number;
  breakpointStyles5?: string;
}

const {
  placeholderImage,
  compressedVideo,
  qualityVideo,
  startTimestamp,
  width,
  height,
  className = "",
  alt = "Video placeholder",
  muted = true,
  loop = true,
  controls = false,
  preloadQuality = "none",
  fullWidth = true,
  containerStyle = "",
  portraitAspectRatio,
  landscapeAspectRatio,
  maxWidthBreakpoint1,
  breakpointStyles1 = "",
  maxWidthBreakpoint2,
  breakpointStyles2 = "",
  maxWidthBreakpoint3,
  breakpointStyles3 = "",
  maxWidthBreakpoint4,
  breakpointStyles4 = "",
  maxWidthBreakpoint5,
  breakpointStyles5 = "",
} = Astro.props;

// Build the style string properly
const baseStyle =
  !fullWidth && width && height
    ? `width: ${width}px; height: ${height}px;`
    : "";

const combinedStyle = [baseStyle, containerStyle].filter(Boolean).join(" ");

// Generate unique IDs for this component instance
const componentId = `progressive-video-${Math.random().toString(36).substr(2, 9)}`;
const placeholderId = `${componentId}-placeholder`;
const compressedId = `${componentId}-compressed`;
const qualityId = `${componentId}-quality`;
---

<div
  class={`progressive-video-container ${className} ${fullWidth ? "full-width" : ""}`}
  data-component-id={componentId}
  data-portrait-aspect={portraitAspectRatio}
  data-landscape-aspect={landscapeAspectRatio}
  style={combinedStyle}
>
  <!-- Placeholder Image -->
  <img
    id={placeholderId}
    src={placeholderImage}
    alt={alt}
    class="progressive-video-placeholder"
  />

  <!-- Compressed Video (loads first) -->
  <video
    id={compressedId}
    class="progressive-video-compressed"
    muted={muted}
    loop={loop}
    playsinline
    controls={controls}
    preload="auto"
    data-start-time={startTimestamp}
    style="opacity: 0;"
  >
    <source src={compressedVideo} type="video/mp4" />
  </video>

  <!-- High Quality Video (loads in background) -->
  <video
    id={qualityId}
    class="progressive-video-quality"
    muted={muted}
    loop={loop}
    playsinline
    controls={controls}
    preload={preloadQuality}
    data-start-time={startTimestamp}
    style="opacity: 0;"
  >
    <source src={qualityVideo} type="video/mp4" />
  </video>
</div>

<style>
  .progressive-video-container {
    position: relative;
    display: block;
    overflow: hidden;
    background: #000;

    @media (max-width: 1279px){
      box-shadow: 6px 6px var(--black) !important;
    }
  }

  .progressive-video-container.full-width {
    width: 100%;
    height: auto;
    /* aspect-ratio will be set dynamically by JavaScript */
  }

  .progressive-video-placeholder {
    position: relative;
    width: 100%;
    height: auto;
    object-fit: cover;
    z-index: 3;
    transition: opacity 0.5s ease-in-out;
    display: block; /* Ensure it takes up space to establish container height */
  }

  .progressive-video-compressed,
  .progressive-video-quality {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: opacity 0.5s ease-in-out;
    outline: none;
  }

  .progressive-video-compressed {
    z-index: 2;
  }

  .progressive-video-quality {
    z-index: 1;
  }

  /* Ensure videos are visible when opacity is set to 1 */
  .progressive-video-compressed[style*="opacity: 1"],
  .progressive-video-quality[style*="opacity: 1"] {
    display: block;
  }



</style>

{maxWidthBreakpoint1 && breakpointStyles1 && (
  <style is:inline>
    {`@media (max-width: ${maxWidthBreakpoint1}px) {
      [data-component-id="${componentId}"] {
        ${breakpointStyles1}
      }
    }`}
  </style>
)}

{maxWidthBreakpoint2 && breakpointStyles2 && (
  <style is:inline>
    {`@media (max-width: ${maxWidthBreakpoint2}px) {
      [data-component-id="${componentId}"] {
        ${breakpointStyles2}
      }
    }`}
  </style>
)}

{maxWidthBreakpoint3 && breakpointStyles3 && (
  <style is:inline>
    {`@media (max-width: ${maxWidthBreakpoint3}px) {
      [data-component-id="${componentId}"] {
        ${breakpointStyles3}
      }
    }`}
  </style>
)}

{maxWidthBreakpoint4 && breakpointStyles4 && (
  <style is:inline>
    {`@media (max-width: ${maxWidthBreakpoint4}px) {
      [data-component-id="${componentId}"] {
        ${breakpointStyles4}
      }
    }`}
  </style>
)}

{maxWidthBreakpoint5 && breakpointStyles5 && (
  <style is:inline>
    {`@media (max-width: ${maxWidthBreakpoint5}px) {
      [data-component-id="${componentId}"] {
        ${breakpointStyles5}
      }
    }`}
  </style>
)}

<script>
  class ProgressiveVideoLoader {
    constructor(componentId) {
      this.componentId = componentId;
      this.container = document.querySelector('[data-component-id="' + componentId + '"]');
      this.placeholder = document.getElementById(componentId + '-placeholder');
      this.compressedVideo = document.getElementById(componentId + '-compressed');
      this.qualityVideo = document.getElementById(componentId + '-quality');
      this.startTimestamp = parseFloat(this.compressedVideo.dataset.startTime);

      this.portraitAspectRatio = this.container.getAttribute('data-portrait-aspect');
      this.landscapeAspectRatio = this.container.getAttribute('data-landscape-aspect');

      this.isCompressedLoaded = false;
      this.isQualityLoaded = false;
      this.isCompressedPlaying = false;
      this.hasSetInitialTime = false;
      this.hasSwitchedToQuality = false;
      this.isQualityPlaying = false;
      this.aspectRatioSet = false;

      this.init();
    }

    init() {
      this.setupEventListeners();
      this.setAspectRatioFromPlaceholder();
      this.setupOrientationListener();
      this.startLoading();
    }

    setAspectRatioFromPlaceholder() {
      if (this.placeholder.complete && this.placeholder.naturalWidth > 0) {
        this.updateAspectRatio();
      } else {
        this.placeholder.addEventListener("load", () => {
          this.updateAspectRatio();
        });
      }
    }

    updateAspectRatio() {
      const naturalWidth = this.placeholder.naturalWidth;
      const naturalHeight = this.placeholder.naturalHeight;

      if (naturalWidth > 0 && naturalHeight > 0) {
        this.adjustAspectRatioForOrientation();
        this.aspectRatioSet = true;
      }
    }

    setupOrientationListener() {
      const mediaQuery = window.matchMedia("(orientation: portrait)");
      mediaQuery.addEventListener("change", () => {
        this.adjustAspectRatioForOrientation();
      });
    }

    adjustAspectRatioForOrientation() {
      if (!this.aspectRatioSet && !this.placeholder.complete) return;

      const isPortrait = window.matchMedia("(orientation: portrait)").matches;
      let aspectRatio;

      if (isPortrait && this.portraitAspectRatio) {
        aspectRatio = this.portraitAspectRatio;
      } else if (!isPortrait && this.landscapeAspectRatio) {
        aspectRatio = this.landscapeAspectRatio;
      } else {
        const naturalWidth = this.placeholder.naturalWidth;
        const naturalHeight = this.placeholder.naturalHeight;
        if (naturalWidth > 0 && naturalHeight > 0) {
          aspectRatio = naturalWidth + ' / ' + naturalHeight;
        }
      }

      if (aspectRatio) {
        this.container.style.aspectRatio = aspectRatio;
      }
    }

    setupEventListeners() {
      this.compressedVideo.addEventListener("loadedmetadata", () => {
        this.setInitialTime(this.compressedVideo);
      });

      this.compressedVideo.addEventListener("loadeddata", () => {
        this.isCompressedLoaded = true;
        this.setInitialTime(this.compressedVideo);
      });

      this.compressedVideo.addEventListener("canplay", () => {
        this.startCompressedVideo();
      });

      this.compressedVideo.addEventListener("playing", () => {
        this.isCompressedPlaying = true;
        this.hideElement(this.placeholder);
        this.showElement(this.compressedVideo);
      });

      this.compressedVideo.addEventListener("timeupdate", () => {
        this.syncQualityVideo();
      });

      this.qualityVideo.addEventListener("loadedmetadata", () => {
        this.setInitialTime(this.qualityVideo);
      });

      this.qualityVideo.addEventListener("loadeddata", () => {
        this.isQualityLoaded = true;
        this.setInitialTime(this.qualityVideo);
      });

      this.qualityVideo.addEventListener("canplaythrough", () => {
        if (!this.isQualityLoaded) {
          this.isQualityLoaded = true;
          if (
            this.isCompressedPlaying &&
            !this.hasSwitchedToQuality &&
            !this.isQualityPlaying
          ) {
            setTimeout(() => {
              this.switchToQualityVideo();
            }, 200);
          }
        }
      });

      this.qualityVideo.addEventListener("playing", () => {
        this.isQualityPlaying = true;
        this.hideElement(this.compressedVideo);
        setTimeout(() => {
          this.compressedVideo.pause();
        }, 100);
      });

      this.compressedVideo.addEventListener("error", (e) => {
        console.error("Compressed video error:", e, this.compressedVideo.error);
      });

      this.qualityVideo.addEventListener("error", (e) => {
        console.error("Quality video error:", e, this.qualityVideo.error);
      });

      window.addEventListener("resize", () => {
        this.adjustAspectRatioForOrientation();
      });
    }

    setInitialTime(video) {
      if (
        !this.hasSetInitialTime &&
        video.duration &&
        this.startTimestamp < video.duration
      ) {
        video.currentTime = this.startTimestamp;
        if (video === this.compressedVideo) {
          this.hasSetInitialTime = true;
        }
      }
    }

    startLoading() {
      this.compressedVideo.load();

      setTimeout(() => {
        if (!this.hasSwitchedToQuality) {
          this.qualityVideo.load();
        }
      }, 1000);
    }

    startCompressedVideo() {
      if (this.isCompressedLoaded && !this.isCompressedPlaying) {
        if (
          Math.abs(this.compressedVideo.currentTime - this.startTimestamp) > 0.1
        ) {
          this.compressedVideo.currentTime = this.startTimestamp;
        }

        setTimeout(() => {
          this.compressedVideo
            .play()
            .then(() => {})
            .catch((e) => {
              console.error("Error playing compressed video:", e);
              this.compressedVideo.currentTime = 0;
              this.compressedVideo.play().catch((err) => {
                console.error("Fallback play also failed:", err);
              });
            });
        }, 100);
      }
    }

    syncQualityVideo() {
      if (
        this.isQualityLoaded &&
        this.isCompressedPlaying &&
        this.qualityVideo.paused &&
        !this.isQualityPlaying
      ) {
        this.qualityVideo.currentTime = this.compressedVideo.currentTime;
      }
    }

    switchToQualityVideo() {
      if (
        !this.isQualityLoaded ||
        !this.isCompressedPlaying ||
        this.hasSwitchedToQuality ||
        this.isQualityPlaying
      ) {
        return;
      }

      this.hasSwitchedToQuality = true;

      this.qualityVideo.currentTime = this.compressedVideo.currentTime;

      this.qualityVideo
        .play()
        .then(() => {
          this.showElement(this.qualityVideo);
        })
        .catch((e) => {
          console.error("Error playing quality video:", e);
          this.hasSwitchedToQuality = false;
        });
    }

    showElement(element) {
      element.style.opacity = "1";
    }

    hideElement(element) {
      element.style.opacity = "0";
    }
  }

  document.addEventListener("DOMContentLoaded", initializeComponents);

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initializeComponents);
  } else {
    initializeComponents();
  }

  function initializeComponents() {
    const containers = document.querySelectorAll(
      '[data-component-id^="progressive-video-"]:not([data-initialized])'
    );
    containers.forEach((container) => {
      const componentId = container.getAttribute("data-component-id");
      new ProgressiveVideoLoader(componentId);
      container.setAttribute("data-initialized", "true");
    });
  }
</script>